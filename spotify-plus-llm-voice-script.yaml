blueprint:
  name: Voice - SpotifyPlus - Full LLM script
  source_url: https://github.com/Charghoul/spotify-plus-llm-voice-assist/blob/main/spotify-plus-llm-voice-script.yaml
  description: '
    `v0.0.8`
    
    # Creates a script which will allow voice requests for SpotifyPlus

    * No changes are required for any of the settings below for this script to work,
    but your specific LLM integration may need some fine-tuning. To do that, adjust
    the prompts sent to the LLM.

    * **Make sure to expose the script to Assist after creating it.**

    * **Make sure to give the script a clear description.** An example can be found
    below.

    * It is possible to add additional actions to be performed after the SpotifyPlus
    play media action. There are several variables available which are described below.


    ## Example for script description

    `This script is used to play music from Spotify based on a voice request. The tool takes the
    following arguments: media_type, artist, track, media_id, shuffle, source_name. media_id,
    media_type are always required and must always be supplied as arguments to this
    tool. A source or area can optionally be provided in the voice request as well. 
    Use the parameters as described in the description of each parameter. 
    Use this tool whenever the user requests to play music from Spotify.`

    ## Available variables for additional actions

    |Variable|Description|

    |---|---|

    |`media_id`|The general description of the media, can be a song name, radio station,
    album name, etc. For Spotify URIs or IDs, this will be the full URI/ID.|

    |`media_type`|Will be one of the following: `"track"`, `"artist"`, `"album"`,
    `"playlist"`, `"podcast"`, `"radio"`|

    |`artist`|The artist requested in the voice command. Will be empty in case the
    artist is not relevant or when there are multiple artists requested|

    |`track`|The track/song requested in the voice command, will be empty in case the track
    is not relevant or when multiple tracks are requested|

    |`media_description`|The description used in the voice request to describe the
    media. For example if the voice request was "Play the best songs from Queen in
    the living room" the value for this variable will be "the best songs from Queen"

    |`area`|The area(s) determined by the LLM in which the request will be played.
    The variable will undefined in case there was no area information, in case it
    is defined it will be a list of area_ids|

    |`source_name`|The Spotify Connect source name determined by the LLM on which
    the request will be played. The variable will be undefined if there was no source
    provided in the request.|

    |`default_entity`|The default SpotifyPlus entity provided when setting up the script or `none`
    if no entity is provided.|

    |`shuffle`|Whether or not to turn on the shuffle setting on the player that handles the request.
    It will be set based on whether or not the request mentions wanting to shuffle the music.
    The value will either be true or false.|'
  domain: script
  author: Jan Eisenbarth
  homeassistant:
    min_version: 2024.6.0
  input:
    spotify_plus_settings:
      name: Settings for SpotifyPlus playback
      icon: mdi:spotify
      description: You can use these settings to configure how SpotifyPlus playback
        is handled.
      input:
        default_entity:
          name: Default SpotifyPlus Entity
          description: 'The SpotifyPlus media player entity that will be used for all playback.
            This is required since the thlucas1 SpotifyPlus integration uses a single entity
            with multiple sources rather than multiple entities.'
          selector:
            entity:
              filter:
                domain:
                - media_player
                integration: spotifyplus
              multiple: false
          default:
        default_device:
          name: Default Source
          description: 'Default Spotify Connect source to use if none specified in the request. This can be any device you have connected to Spotify - a speaker, phone, computer, etc. Enter "none" to always use the current active device if available.'
          selector:
            text:
          default:
        force_device_activation:
          name: Force Device Activation
          description: 'Force the device to reconnect to Spotify Connect before transferring playback.
            This is useful if devices sometimes appear as available but actually need to be re-activated.'
          selector:
            boolean:
          default: true
        device_transfer_delay:
          name: Device Transfer Delay
          description: 'Time delay (in seconds) to wait after transferring playback to a device.
            This gives Spotify time to process the change before attempting to play media.'
          selector:
            number:
              min: 0
              max: 10
              step: 0.1
              mode: slider
              unit_of_measurement: seconds
          default: 1
        search_limit:
          name: Search Limit
          description: 'The maximum number of search results to return when searching
            for tracks, artists, albums, playlists or shows.'
          selector:
            number:
              min: 1
              max: 50
              mode: slider
              step: 1
          default: 5
    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: You can use these settings to fine-tune the prompts for your specific
        LLM (model). In most cases the defaults should be fine.
      collapsed: true
      input:
        media_type_prompt:
          name: Media Type Prompt
          description: The prompt that the LLM will use to provide the media_type.
          selector:
            text:
              multiline: true
              multiple: false
          default: 'This argument is mandatory and must always be provided no matter
            what!

            "media_type" can only be one of 6 different values:

            - "track" if the search is about a specific track or a list of tracks.

            - "album" if the search is about an album or a list of albums.

            - "artist" if the search is about an artist.

            - "playlist" if the search specifically requests a playlist.

            - "podcast" if the search is about a podcast or show.

            - "radio" if the search is a radio channel or artist radio.

            media_type is mandatory and must always be provided. If a request does
            not match any of these types, for example when music from a specific genre
            is requested, then use "track" and provide a list of matching songs for
            the "media_id" parameter.'
        artist_prompt:
          name: Artist Prompt
          description: The prompt that the LLM will use to provide the artist.
          selector:
            text:
              multiline: true
              multiple: false
          default: '"artist" is the artist the user requests to play, or the artist
            of a specific track if the user mentions it while requesting to play a
            specific song. 
            
            For example, if the request is "Play Bohemian Rhapsody by Queen", the artist would be "Queen".
            
            If the artist is unknown or there are multiple artists requested, 
            use an empty string.'
        track_prompt:
          name: Track Prompt
          description: The prompt that the LLM will use to provide the track.
          selector:
            text:
              multiline: true
              multiple: false
          default: '"track" is the specific song or track the user wants to play.
            If the user requests a specific song, provide the song title here.
            
            For example, if the request is "Play Bohemian Rhapsody by Queen", the track would be "Bohemian Rhapsody".
            
            If the track is unknown or there are multiple tracks requested, 
            use an empty string.'
        media_id_prompt:
          name: Media ID Prompt
          description: The prompt that the LLM will use to provide the media_id.
          selector:
            text:
              multiline: true
              multiple: false
          default: 'This argument is mandatory and must always be provided no matter
            what!

            media_id is a descriptive search term that will be used to find the content in Spotify.
            
            - If media_type is "track": Then media_id should be the track name or a list of track names. 
              If there are multiple artists in the result, include both the artist name and song name 
              (example: "Artist name - Song name"). If all songs are from the same artist, use the 
              artist parameter separately, and only provide song names in media_id.

            - If media_type is "album": Then media_id should be the album name.

            - If media_type is "artist": Then media_id should be the artist name.

            - If media_type is "playlist": Then media_id should be the playlist name.

            - If media_type is "podcast": Then media_id should be the podcast/show name.

            - If media_type is "radio": Then media_id should be the artist name followed by "Radio".

            This is a mandatory argument and must always be provided. The system will search Spotify 
            for the closest match to what you provide here.'
        media_description_prompt:
          name: Media Description Prompt
          description: The prompt that the LLM will use to provide the media description.
          selector:
            text:
              multiline: true
              multiple: false
          default: The "media_description" key is used to describe the media which
            will be played. This can be taken from the voice command query, but it
            should be only the part which is relevant for the media. So if the voice
            request is "Play the best Queen songs on the living room player" the value
            for "media_description" should be "the best Queen songs"
        area_prompt:
          name: Area Prompt
          description: The prompt that the LLM will use to provide the area.
          selector:
            text:
              multiline: true
              multiple: false
          default: 'The area or areas for which the music is requested. If the request
            does not mention a target (either an area or a source), use the area the
            request comes from.

            If the area can not be determined from the request, or the source the
            request comes from, do not use this parameter.

            Only use both the "area" parameter and the "source_name" parameter together
            if both are specifically used in the request.'
        source_name_prompt:
          name: Source Name Prompt
          description: >-
            The description that will be used in the message to either skip or
            suggest a source that is different from the default one.
          default: >-
            You can specify a source for playback by saying "on the [source name]".
            For example, "Play Queen on the living room" or "Play relaxing music in the bedroom".
            Available sources are the ones listed in your SpotifyPlus media player's source_list.
        shuffle_prompt:
          name: Shuffle Prompt
          description: The prompt that the LLM will use to determine whether to turn on shuffle or not.
          selector:
            text:
              multiline: true
              multiple: false
          default: 'This argument is mandatory and must always be provided no matter
            what!
            
            If the request mentions shuffling the music, then the "shuffle" is set to true. 
            Otherwise, "shuffle" is set to false.
            
            For example, if the request is "Shuffle music by Muse", then "shuffle" should be set to true.
            
            If the request is "Play music by Billy Talent", "shuffle" would be false 
            since the request did not mention or request to shuffle.

            If the request is "Shuffle the playlist Liked Songs", then "shuffle" should be set to true.

            If the request is "Play the artist Guns and Roses", "shuffle" should be set to false, since the request 
            does not mention or request to shuffle.
            '
    addition_conditions_actions:
      name: Additional actions
      icon: mdi:wrench
      description: You can add additional actions to be performed after the Spotify play
        media action is started. Variables which can always be used
        are media_id, media_type, track, artist. Based on the request, the variables
        area and source_name can also be available.
      collapsed: true
      input:
        actions:
          name: Additional actions
          selector:
            action: {}
          default: []
mode: parallel
max_exceeded: silent
description: This script is used to play music from Spotify based on a voice request. You only need to provide 
  descriptive information like artist names, song titles, or playlist names - the script will handle searching 
  for the best match in Spotify. The media_type and media_id parameters are required. You can optionally 
  specify a source (Spotify Connect device) or area.
fields:
  media_type:
    selector:
      select:
        options:
        - track
        - album
        - artist
        - playlist
        - podcast
        - radio
    name: Media Type
    description: !input media_type_prompt
    required: true
  artist:
    selector:
      text:
    name: Artist
    description: !input artist_prompt
    required: true
  track:
    selector:
      text:
    name: Track
    description: !input track_prompt
    required: true
  media_id:
    selector:
      text:
    name: Media ID
    description: !input media_id_prompt
    required: true
  media_description:
    selector:
      text:
    name: Media Description
    description: !input media_description_prompt
    required: true
  area:
    selector:
      area:
        multiple: true
    name: Area
    description: !input area_prompt
  source_name:
    selector:
      text:
    name: Source Name
    description: !input source_name_prompt
  shuffle:
    selector:
      boolean:
    name: Shuffle
    description: !input shuffle_prompt
sequence:
- variables:
    version: 20250626
    default_entity: !input default_entity
    default_device: !input default_device
    force_device_activation: !input force_device_activation
    device_transfer_delay: !input device_transfer_delay
    search_limit: !input search_limit
    shuffle: '{{ shuffle }}'
    target_device: '{{ source_name | default(default_device, true) }}'
    invalid_target:
      response: Unable to find valid target
- if:
  - condition: template
    value_template: >-
      {% if not default_entity %}true{% else %}false{% endif %}
  then:
  - stop: No valid SpotifyPlus entity specified for Voice script
    response_variable: invalid_target
# Get available source list from the SpotifyPlus entity
- variables:
    source_list: '{{ state_attr(default_entity, "source_list") | default([]) }}'
    media_id_safe: '{{ media_id | default("") }}'
    artist_safe: '{{ artist | default("") }}'
    track_safe: '{{ track | default("") }}'
    # Simply detect if it's a spotify URI
    # Completely avoid len(), startswith() and other problematic methods
    is_spotify_uri: >-
      {% if media_id_safe %}
        {% if 'spotify:' in media_id_safe %}
          true
        {% else %}
          false
        {% endif %}
      {% else %}
        false
      {% endif %}
    search_term_track: '{{ (artist_safe + " " if artist_safe else "") + (track_safe if track_safe else media_id_safe) }}'
    search_term_artist: '{{ artist_safe if artist_safe else media_id_safe }}'
    search_term_album: '{{ (artist_safe + " " if artist_safe else "") + media_id_safe }}'
    search_term_playlist: '{{ media_id_safe }}'
    search_term_podcast: '{{ media_id_safe }}'
    search_term_radio: >-
      {% if artist_safe %}
        {{ artist_safe }}
      {% else %}
        {% if ' Radio' in media_id_safe %}
          {{ media_id_safe | replace(" Radio", "") }}
        {% else %}
          {{ media_id_safe }}
        {% endif %}
      {% endif %}
# Get list of available Spotify Connect devices
- alias: Get available Spotify Connect devices
  action: spotifyplus.get_player_devices
  data:
    entity_id: '{{ default_entity }}'
    refresh: true
    sort_result: true
  response_variable: available_devices
- choose:
  # Search for tracks when necessary
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "track" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.search_tracks
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_track }}'
        limit: '{{ search_limit }}'
      response_variable: track_search_results
    - variables:
        media_id: >-
          {% if track_search_results and track_search_results.result and track_search_results.result.items and track_search_results.result.items[0] %}
            {{ track_search_results.result.items[0].id }}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: track
  # Search for artists when necessary
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "artist" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - service: system_log.write
      data:
        level: info
        message: >-
          Artist search triggered with:
          media_type: {{ media_type }}
          artist_safe: {{ artist_safe }}
          search_term_artist: {{ search_term_artist }}
    - action: spotifyplus.search_artists
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_artist }}'
        limit: '{{ search_limit }}'
      response_variable: artist_search_results
    - variables:
        media_id: >-
          {% if artist_search_results and artist_search_results.result and artist_search_results.result.items and artist_search_results.result.items[0] %}
            {% if artist_search_results.result.items[0].uri %}
              {{ artist_search_results.result.items[0].uri }}
            {% else %}
              {{ artist_search_results.result.items[0].id }}
            {% endif %}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: artist
        is_spotify_uri: >-
          {% if artist_search_results and artist_search_results.result and artist_search_results.result.items and artist_search_results.result.items[0] and artist_search_results.result.items[0].uri %}
            true
          {% else %}
            false
          {% endif %}
        # Log the search result for debugging
        search_debug: >-
          {% if artist_search_results %}
            Artist search found: {{ artist_search_results.result.items | default([]) | length }} results.
            {% if artist_search_results.result.items and artist_search_results.result.items[0] %}
              First result ID: {{ artist_search_results.result.items[0].id }}
              Name: {{ artist_search_results.result.items[0].name }}
              URI: {{ artist_search_results.result.items[0].uri }}
            {% endif %}
          {% else %}
            No results found.
          {% endif %}
  # Search for albums when necessary
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "album" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.search_albums
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_album }}'
        limit: '{{ search_limit }}'
      response_variable: album_search_results
    - variables:
        media_id: >-
          {% if album_search_results and album_search_results.result and album_search_results.result.items and album_search_results.result.items[0] %}
            {{ album_search_results.result.items[0].id }}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: album
  # Search for playlists when necessary
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "playlist" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.search_playlists
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_playlist }}'
        limit: '{{ search_limit }}'
      response_variable: playlist_search_results
    - variables:
        media_id: >-
          {% if playlist_search_results and playlist_search_results.result and playlist_search_results.result.items and playlist_search_results.result.items[0] %}
            {{ playlist_search_results.result.items[0].id }}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: playlist
  # Search for podcasts when necessary
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "podcast" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.search_shows
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_podcast }}'
        limit: '{{ search_limit }}'
      response_variable: podcast_search_results
    - variables:
        media_id: >-
          {% if podcast_search_results and podcast_search_results.result and podcast_search_results.result.items and podcast_search_results.result.items[0] %}
            {{ podcast_search_results.result.items[0].id }}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: show
  # Search for radio
  - conditions:
    - condition: template
      value_template: >-
        {% if media_type == "radio" and not is_spotify_uri %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.search_artists
      data:
        entity_id: '{{ default_entity }}'
        criteria: '{{ search_term_radio }}'
        limit: '{{ search_limit }}'
      response_variable: radio_search_results
    - variables:
        media_id: >-
          {% if radio_search_results and radio_search_results.result and radio_search_results.result.items and radio_search_results.result.items[0] %}
            {{ radio_search_results.result.items[0].id }}
          {% else %}
            {{ media_id_safe }}
          {% endif %}
        media_type_uri: artist
  default:
  - variables:
      media_type_uri: '{{ media_type }}'
      search_debug: >-
        Default case triggered! This likely means no search was performed.
        Media type: {{ media_type }}
        Is Spotify URI: {{ is_spotify_uri }}
        Original media ID: {{ media_id_safe }}
      
# Add a specific check for artist to ensure it's properly handled
- if: 
  - condition: template
    value_template: >-
      {% if media_type == "artist" and not media_id and not is_spotify_uri %}true{% else %}false{% endif %}
  then:
  - action: spotifyplus.search_artists
    data:
      entity_id: '{{ default_entity }}'
      criteria: '{{ artist_safe }}'
      limit: '{{ search_limit }}'
    response_variable: artist_search_results
  - variables:
      media_id: >-
        {% if artist_search_results and artist_search_results.result and artist_search_results.result.items and artist_search_results.result.items[0] %}
          {% if artist_search_results.result.items[0].uri %}
            {{ artist_search_results.result.items[0].uri }}
          {% else %}
            {{ artist_search_results.result.items[0].id }}
          {% endif %}
        {% else %}
          {{ artist_safe }}
        {% endif %}
      media_type_uri: artist
      is_spotify_uri: >-
        {% if artist_search_results and artist_search_results.result and artist_search_results.result.items and artist_search_results.result.items[0] and artist_search_results.result.items[0].uri %}
          true
        {% else %}
          false
        {% endif %}
      search_debug: >-
        Emergency artist search performed!
        Artist search found: {{ artist_search_results.result.items | default([]) | length }} results.
        {% if artist_search_results.result.items and artist_search_results.result.items[0] %}
          First result ID: {{ artist_search_results.result.items[0].id }}
          Name: {{ artist_search_results.result.items[0].name }}
          URI: {{ artist_search_results.result.items[0].uri }}
        {% endif %}

# Prepare the final media ID/URI format
- if:
  - condition: template
    value_template: >-
      {% if is_spotify_uri %}true{% else %}false{% endif %}
  then:
  - variables:
      final_media_id: '{{ media_id_safe }}'
      final_media_type: '{{ media_type_uri if media_type_uri is defined else media_type }}'
  else:
  - variables:
      # Ensure we have a valid media ID - if empty, don't add any colons
      final_media_id: >-
        {% if media_id %}
          {% if media_type == "artist" and artist_search_results and artist_search_results.result and artist_search_results.result.items and artist_search_results.result.items[0] and artist_search_results.result.items[0].uri %}
            {{ artist_search_results.result.items[0].uri }}
          {% else %}
            spotify:{{ media_type_uri }}:{{ media_id }}
          {% endif %}
        {% else %}
          {{ media_id_safe }}
        {% endif %}
      final_media_type: '{{ media_type }}'
      
  # Log the final media ID after construction
  - service: system_log.write
    data:
      level: info
      message: >-
        Final media ID constructed: {{ final_media_id }}
        from media_type: {{ media_type }}
        and media_id: {{ media_id }}

# Determine target source based on the request or defaults
- variables:
    # Check if requested source exists in the source list
    source_found: >-
      {% if target_device %}
        {% if source_list and target_device in source_list %}
          true
        {% else %}
          false
        {% endif %}
      {% else %}
        false
      {% endif %}

# Handle source selection if needed
- choose:
  - conditions:
    - condition: template
      value_template: >-
        {% if source_found %}true{% else %}false{% endif %}
    sequence:
    - alias: Select requested source for playback
      service: media_player.select_source
      target:
        entity_id: '{{ default_entity }}'
      data:
        source: '{{ target_device }}'
  # If specific source requested but not found, show warning
  - conditions:
    - condition: template
      value_template: >-
        {% if target_device and not source_found %}true{% else %}false{% endif %}
    sequence:
    - alias: Log warning about source not found
      service: system_log.write
      data:
        level: warning
        message: "Requested source '{{ target_device }}' not found in available sources. Will use current source instead."
  # If no specific source requested, skip source selection
  default: []
# Set shuffle mode
- alias: Set shuffle mode
  action: spotifyplus.player_set_shuffle_mode
  data:
    state: '{{ shuffle }}'
    entity_id: '{{ default_entity }}'
    delay: 1
  continue_on_error: true
# Play the requested content
- alias: Play requested content
  choose:
  - conditions:
    - condition: template
      value_template: >-
        {% if final_media_type == "track" %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.player_media_play_tracks
      data:
        entity_id: '{{ default_entity }}'
        uris: '{{ final_media_id }}'
      continue_on_error: true
  # Check if we have a URI from search
  - conditions:
    - condition: template
      value_template: >-
        {% if is_spotify_uri and media_id and media_id is string and 'spotify:' in media_id %}true{% else %}false{% endif %}
    sequence:
    - service: system_log.write
      data:
        level: info
        message: "Using direct URI from search: {{ media_id }}"
    - action: spotifyplus.player_media_play_context
      data:
        entity_id: '{{ default_entity }}'
        context_uri: '{{ media_id }}'
      continue_on_error: true
  # Regular context playback
  - conditions:
    - condition: template
      value_template: >-
        {% if final_media_type == "playlist" or final_media_type == "album" or final_media_type == "artist" or final_media_type == "show" %}true{% else %}false{% endif %}
    sequence:
    - action: spotifyplus.player_media_play_context
      data:
        entity_id: '{{ default_entity }}'
        context_uri: '{{ final_media_id }}'
      continue_on_error: true
  # Default fallback to standard media_player
  default:
  - action: media_player.play_media
    target:
      entity_id: '{{ default_entity }}'
    data:
      media_content_id: '{{ final_media_id }}'
      media_content_type: '{{ final_media_type }}'
    continue_on_error: true
  
# Add debugging info to log
- service: system_log.write
  data:
    level: info
    message: >-
      SpotifyPlus script executed with:
      media_type: {{ media_type }}
      artist: {{ artist_safe }}
      media_id original: {{ media_id_safe }}
      media_id final: {{ final_media_id }}
      media_type_uri: {{ media_type_uri|default('none') }}
      final_media_type: {{ final_media_type }}
      {% if search_debug is defined %}Search debug: {{ search_debug }}{% endif %}
- sequence: !input actions 
